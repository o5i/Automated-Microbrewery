<!-- <?php echo "--".">";
include_once $_SERVER['DOCUMENT_ROOT'] . '/include/prepend.inc';
siteHeader("Modbus Master Protocol Library / C++ Editions - How to integrate the Protocol in your Application",
           // Description:
           "Modbus RTU, Modbus ASCII, MODBUS/TCP Master C++ library and driver Documentation",
           // Keywords:
           $keywords);
echo "<"."!--"; if (false) { ?> -->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
<head>
   <TITLE>FieldTalk Modbus Master Protocol Library / C++ Editions - How to integrate the Protocol in your Application</TITLE>
   <LINK href="style.css" rel="stylesheet" type="text/css">
</head>
<body>
   <table width="100%"><tr>
   <td valign=bottom><b><font color=black size=4>
      FieldTalk<small><sup>&#153;</sup></small> Modbus<small><sup>&reg;</sup></small> Master Protocol Library<br>
      C++ Editions</font></b></td>
   <td valign=bottom align=right>
      <a href="http://www.focus-sw.com">
      <img src="focuslogo50x200.png" border=0 size="50%"
       alt="FOCUS Software Engineering" ></a></td>
   </tr></table>
   <hr size=4 noshade color=gray>
<!-- <?php } echo "--".">"; echo "<"."!--"; ?> -->

<!-- Generated by Doxygen 1.3.3 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Compound&nbsp;List</a> | <a class="qindex" href="functions.html">Compound&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1><a name="integrate">How to integrate the Protocol in your Application</a>
</h1><h2><a name="serialintegrate"></a>
Using Serial Protocols</h2>
Let's assume we want to talk to a Modbus slave device with slave address 1.<p>
The registers for reading are in the reference range 4:00100 to 4:00119 and the registers for writing are in the range 4:00200 to 4:00219. The discretes for reading are in the reference range 0:00010 to 0:00019 and the discretes for writing are in the range 0:00020 to 0:00029.<p>
1. Include the package header files <div class="fragment"><pre><span class="preprocessor">#include "MbusRtuMasterProtocol.hpp"</span>
</pre></div><p>
2. Device data profile definition<p>
Define the data sets which reflects the slave's data profile by type and size: <div class="fragment"><pre><span class="keywordtype">short</span> readRegSet[20];
<span class="keywordtype">short</span> writeRegSet[20];
<span class="keywordtype">int</span> readBitSet[20];
<span class="keywordtype">int</span> writeBitSet[20];
</pre></div><p>
If you are using floats instead of 16-bit shorts define: <div class="fragment"><pre><span class="keywordtype">float</span> readFloatSet[10];
<span class="keywordtype">float</span> writeFloatSet[10];
</pre></div>Note that because a float occupies two 16-bit registers the array size is half the size it would be for 16-bit shorts!<p>
If you are using 32-bit ints instead of 16-bit shorts define: <div class="fragment"><pre><span class="keywordtype">long</span> readLongSet[10];
<span class="keywordtype">long</span> writeLongSet[10];
</pre></div>Note that because a long occupies two 16-bit registers the array size is half the size it would be for 16-bit shorts!<p>
3. Declare and instantiate a protocol object <div class="fragment"><pre><a class="code" href="a00010.html">MbusRtuMasterProtocol</a> mbusProtocol;
</pre></div><p>
4. Open the protocol <div class="fragment"><pre>   <span class="keywordtype">int</span> result;

   result = mbusProtocol.<a class="code" href="a00010.html#MbusRtuMasterProtocolz3_0">openProtocol</a>(portName,
                                      9600L, <span class="comment">// Baudrate</span>
                                      8,     <span class="comment">// Databits</span>
                                      1,     <span class="comment">// Stopbits</span>
                                      0);    <span class="comment">// Parity</span>
   <span class="keywordflow">if</span> (result != <a class="code" href="a00041.html#a1">FTALK_SUCCESS</a>)
   {
      fprintf(stderr, <span class="stringliteral">"Error opening protocol: %s!\n"</span>,
                       <a class="code" href="a00041.html#a28">getBusProtocolErrorText</a>(result));
      exit(EXIT_FAILURE);
   }
</pre></div><p>
5. Perform the data transfer functions<ul>
<li>To read register values: <div class="fragment"><pre>mbusProtocol.<a class="code" href="a00036.html#a10">readMultipleRegisters</a>(1, 100, readRegSet, <span class="keyword">sizeof</span>(readRegSet) / <span class="keyword">sizeof</span>(<span class="keywordtype">short</span>));
</pre></div></li><li>To write a single register value: <div class="fragment"><pre>mbusProtocol.<a class="code" href="a00036.html#a20">writeSingleRegister</a>(1, 200, 1234);
</pre></div></li><li>To write mutliple register values: <div class="fragment"><pre>mbusProtocol.<a class="code" href="a00036.html#a0">writeMultipleRegisters</a>(1, 200, writeRegSet, <span class="keyword">sizeof</span>(writeRegSet) / <span class="keyword">sizeof</span>(<span class="keywordtype">short</span>));
</pre></div></li><li>To read discrete values: <div class="fragment"><pre>mbusProtocol.<a class="code" href="a00036.html#a1">readCoils</a>(1, 10, readBitSet, <span class="keyword">sizeof</span>(readBitSet) / <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
</pre></div></li><li>To write a single discrete value: <div class="fragment"><pre>mbusProtocol.<a class="code" href="a00036.html#a19">writeCoil</a>(1, 20, 1);
</pre></div></li><li>To write multiple discrete values: <div class="fragment"><pre>mbusProtocol.<a class="code" href="a00036.html#a2">forceMultipleCoils</a>(1, 20, <span class="keyword">sizeof</span>(writeBitSet) / <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
</pre></div></li><li>To read float values: <div class="fragment"><pre>mbusProtocol.<a class="code" href="a00036.html#a13">readMultipleFloats</a>(1, 100, readFloatSet, <span class="keyword">sizeof</span>(readFloatSet) / <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
</pre></div></li><li>To read long integer values: <div class="fragment"><pre>mbusProtocol.<a class="code" href="a00036.html#a11">readMultipleLongInts</a>(1, 100, readLongSet, <span class="keyword">sizeof</span>(readLongSet) / <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>));
</pre></div></li></ul>
<p>
6. Close the protocol port if not needed any more <div class="fragment"><pre>mbusProtocol.<a class="code" href="a00012.html#MbusSerialMasterProtocolz25_2">closeProtocol</a>();
</pre></div><p>
7. Error Handling<p>
Serial protocol errors like slave device failures, transmission failures, checksum errors and time-outs return an error code. The following code snippet can handle and report these errors:<p>
<div class="fragment"><pre>   <span class="keywordtype">int</span> result;

   result = mbusProtocol.<a class="code" href="a00036.html#a10">readMultipleRegisters</a>(1, 100, dataSetArray, 10);
   <span class="keywordflow">if</span> (result != <a class="code" href="a00041.html#a1">FTALK_SUCCESS</a>)
   {
      fprintf(stderr, <span class="stringliteral">"%s!\n"</span>, <a class="code" href="a00041.html#a28">getBusProtocolErrorText</a>(result));
      <span class="comment">// Stop for fatal errors</span>
      <span class="keywordflow">if</span> (!(result &amp; <a class="code" href="a00041.html#a17">FTALK_BUS_PROTOCOL_ERROR_CLASS</a>))
         <span class="keywordflow">return</span>;
   }
</pre></div><p>
An automatic retry mechanism is available and can be enabled with mbusProtocol.setRetryCnt(3) before opening the protocol port.<h2><a name="tcpintegrate"></a>
Using MODBUS/TCP Protocol</h2>
Let's assume we want to talk to a Modbus slave device with unit address 1 and IP address 10.0.0.11.<p>
The registers for reading are in the reference range 4:00100 to 4:00119 and the registers for writing are in the range 4:00200 to 4:00219. The discretes for reading are in the reference range 0:00010 to 0:00019 and the discretes for writing are in the range 0:00020 to 0:00029.<p>
1. Include the package header files <div class="fragment"><pre><span class="preprocessor">#include "MbusTcpMasterProtocol.hpp"</span>
</pre></div><p>
2. Device data profile definition<p>
Define the data sets which reflects the slave's data profile by type and size: <div class="fragment"><pre><span class="keywordtype">short</span> readRegSet[20];
<span class="keywordtype">short</span> writeRegSet[20];
<span class="keywordtype">int</span> readBitSet[10];
<span class="keywordtype">int</span> writeBitSet[10];
</pre></div><p>
If you are using floats instead of 16-bit shorts define: <div class="fragment"><pre><span class="keywordtype">float</span> readFloatSet[10];
<span class="keywordtype">float</span> writeFloatSet[10];
</pre></div>Note that because a float occupies two 16-bit registers the array size is half the size it would be for 16-bit shorts!<p>
If you are using 32-bit ints instead of 16-bit shorts define: <div class="fragment"><pre><span class="keywordtype">long</span> readLongSet[10];
<span class="keywordtype">long</span> writeLongSet[10];
</pre></div>Note that because a long occupies two 16-bit registers the array size is half the size it would be for 16-bit shorts!<p>
3. Declare and instantiate a protocol object <div class="fragment"><pre><a class="code" href="a00013.html">MbusTcpMasterProtocol</a> mbusProtocol;
</pre></div><p>
4. Open the protocol <div class="fragment"><pre>mbusProtocol.<a class="code" href="a00013.html#MbusTcpMasterProtocolz21_0">openProtocol</a>(<span class="stringliteral">"10.0.0.11);</span>
</pre></div><p>
5. Perform the data transfer functions<ul>
<li>To read register values: <div class="fragment"><pre>mbusProtocol.<a class="code" href="a00036.html#a10">readMultipleRegisters</a>(1, 100, readRegSet, <span class="keyword">sizeof</span>(readRegSet) / <span class="keyword">sizeof</span>(<span class="keywordtype">short</span>));
</pre></div></li><li>To write a single register value: <div class="fragment"><pre>mbusProtocol.<a class="code" href="a00036.html#a20">writeSingleRegister</a>(1, 200, 1234);
</pre></div></li><li>To write mutliple register values: <div class="fragment"><pre>mbusProtocol.<a class="code" href="a00036.html#a0">writeMultipleRegisters</a>(1, 200, writeRegSet, <span class="keyword">sizeof</span>(writeRegSet) / <span class="keyword">sizeof</span>(<span class="keywordtype">short</span>));
</pre></div></li><li>To read discrete values: <div class="fragment"><pre>mbusProtocol.<a class="code" href="a00036.html#a1">readCoils</a>(1, 10, readBitSet, <span class="keyword">sizeof</span>(readBitSet) / <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
</pre></div></li><li>To write a single discrete value: <div class="fragment"><pre>mbusProtocol.<a class="code" href="a00036.html#a19">writeCoil</a>(1, 20, 1);
</pre></div></li><li>To write multiple discrete values: <div class="fragment"><pre>mbusProtocol.<a class="code" href="a00036.html#a2">forceMultipleCoils</a>(1, 20, writeBitSet, <span class="keyword">sizeof</span>(writeBitSet) / <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
</pre></div></li><li>To read float values: <div class="fragment"><pre>mbusProtocol.<a class="code" href="a00036.html#a13">readMultipleFloats</a>(1, 100, readFloatSet, <span class="keyword">sizeof</span>(readFloatSet) / <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
</pre></div></li><li>To read long integer values: <div class="fragment"><pre>mbusProtocol.<a class="code" href="a00036.html#a11">readMultipleLongInts</a>(1, 100, readLongSet, <span class="keyword">sizeof</span>(readLongSet) / <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>));
</pre></div></li></ul>
<p>
6. Close the connection if not needed any more <div class="fragment"><pre>mbusProtocol.<a class="code" href="a00013.html#MbusTcpMasterProtocolz21_1">closeProtocol</a>();
</pre></div><p>
7. Error Handling<p>
TCP/IP protocol errors like slave failures, TCP/IP connection failures and time-outs return an error code. The following code snippet can handle these errors:<p>
<div class="fragment"><pre>   <span class="keywordtype">int</span> result;

   result = mbusProtocol.<a class="code" href="a00036.html#a10">readMultipleRegisters</a>(1, 100, dataSetArray, 10);
   <span class="keywordflow">if</span> (result != <a class="code" href="a00041.html#a1">FTALK_SUCCESS</a>)
   {
      fprintf(stderr, <span class="stringliteral">"%s!\n"</span>, <a class="code" href="a00041.html#a28">getBusProtocolErrorText</a>(result));
      <span class="comment">// Stop for fatal errors</span>
      <span class="keywordflow">if</span> (!(result &amp; <a class="code" href="a00041.html#a17">FTALK_BUS_PROTOCOL_ERROR_CLASS</a>))
         <span class="keywordflow">return</span>;
   }
}
</pre></div><p>
If the method returns FTALK_CONNECTION_WAS_CLOSED, it signals that the the TCP/IP connection was lost or closed by the remote end. Before using further data and control functions the connection has to be re-opened succesfully.<h2><a name="examplesintegrate"></a>
Examples</h2>
<ul>
<li><a class="el" href="examples.html#example1">Serial Example</a></li><li><a class="el" href="examples.html#example2">MODBUS/TCP Example</a></li><li><a class="el" href="examples.html#example3">Modpoll application</a> </li></ul>
<!-- <?php echo "--".">";
siteFooter();
echo "<"."!--"; if (false) { ?> -->
   <hr>
   <table width="100%" cellspacing=0 cellpadding=5 border=0>
      <tr>
         <td class=footer valign=top>
         Copyright &copy; 2002-2004 <a href="http://www.focus-sw.com">
         FOCUS Software Engineering Pty Ltd</a>, Australia.
         All rights reserved.
         <br>
         Please see the <a href="notices.html">Notices</a> page for trademark notices.
         <br>
         Last updated: 26 May 2004
     </tr>
   </table>

</body>
</html>
<!-- <?php } echo "--".">"; echo "<"."!--"; ?> -->

